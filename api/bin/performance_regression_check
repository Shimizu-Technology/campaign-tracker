#!/usr/bin/env bash
set -euo pipefail

# Non-production helper to capture baseline and enforce guardrails.
# Usage:
#   api/bin/performance_regression_check
#   DATASET_SIZE=30000 ITERATIONS=10 api/bin/performance_regression_check

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$ROOT_DIR"

DATASET_SIZE="${DATASET_SIZE:-30000}"
ITERATIONS="${ITERATIONS:-7}"

if [[ "$DATASET_SIZE" != "5000" && "$DATASET_SIZE" != "10000" && "$DATASET_SIZE" != "30000" ]]; then
  echo "DATASET_SIZE must be one of: 5000, 10000, 30000"
  exit 1
fi

echo "===> Capturing baseline (dataset_size=$DATASET_SIZE, iterations=$ITERATIONS)"
ITERATIONS="$ITERATIONS" bundle exec rails "performance:capture_baseline[${DATASET_SIZE}]"

echo "===> Running regression guardrail check"
bundle exec rails "performance:regression_check"

echo "===> PASS: performance guardrails satisfied"
